---
title: "Risk Dashboard"
author: "Evaluator toolkit"
output:
  flexdashboard::flex_dashboard:
    css: styles/html-styles.css
    favicon: ./img/evaluator_logo_48px.png
    logo: ./img/evaluator_logo_48px.png
    navbar:
    - align: right
      href: https://github.com/davidski/evaluator
      title: About
    orientation: row
    source_code: embed
    vertical_layout: fill
---

Sample narrative section.

```{r setup, include=FALSE}
library(flexdashboard)
if ("pacman" %in% installed.packages()) {
  pacman::p_load(ggplot2, scales, extrafont, viridis, dplyr, purrr)
  pacman::p_load(readr, pander)
} else  {
  library(ggplot2)
  library(scales)
  library(extrafont)
  library(viridis)
  library(dplyr)
  library(purrr)
  library(readr)
  library(pander)
}
knitr::read_chunk("./bin/load_data.R")
knitr::read_chunk("./bin/common_graphs.R")
knitr::read_chunk("./bin/utils.R")
```

```{r load_data, echo = FALSE, message = FALSE}
```

```{r calculate_domain_impact}
```

```{r calculate_weak_domains}
```

```{r common_functions}
```

```{r useful_values}
# Precalculate the standard order of scenarios (domain, then ID of the scenario)
scenario_order <- results %>% group_by(domain_id, scenario_id) %>% summarise()
# store the `scenario_id` of outliers 
scenario_outliers <- scenario_summary[which(scenario_summary$outlier == TRUE), 
                                      "scenario_id"] %>% unlist %>% unname
# a text vector of numbers to english words
numbers <- c("one", "two", "three", "four", "five", "six", "seven", "eight", 
             "nine")
risk_tolerance <- risk_tolerances$amount
names(risk_tolerance) <- risk_tolerances$level %>% tolower
```

```{r calculate_max_losses}
max_loss <- results %>% filter(!scenario_id %in% scenario_outliers) %>%  
  group_by(simulation) %>% 
  summarise(loss = max(ale),
            min_loss = min(ale),
            max_loss = sum(ale)) %>%
  ungroup
```

Executive Summary
=======================================================================

Row
-----------------------------------------------------------------------

### Aggregate 95% Value at Risk

````{r }
agg_risk <- 100000000
valueBox(dollar_millions(agg_risk), icon = "glyphicon-eye-open",
         color = ifelse(agg_risk > risk_tolerance["high"], "danger", ifelse(
           agg_risk > risk_tolerance["medium"], "warning", "success")))
```

### Minimum Annual Loss (80% Likelyhood)

```{r}
loss_exceedance <- 42000000
valueBox(dollar_millions(loss_exceedance), icon = "glyphicon-warning-sign",
         color = ifelse(loss_exceedance > risk_tolerance["high"], "danger", ifelse(
           loss_exceedance > risk_tolerance["medium"], "warning", "success")))
```

### Median Loss Events Per Year

```{r median_aggregate_loss_events}
loss_events <- group_by(results, simulation) %>% 
  summarise(n = sum(loss_events)) %>% summarize(loss = median(n)) %>% 
  unlist %>% unname
valueBox(comma(loss_events), icon = "glyphicon-flag",
         color = "info")

```

Row {data-height=150}
-----------------------------------------------------------------------

### Domain Heatmap {.no-padding}

```{r domain_heatmap, fig.width=12, fig.height=2}
```

Row
-----------------------------------------------------------------------

### Loss Ranges Across All Scenarios {.no-padding}

```{r loss_across_domains, fig.width=15, fig.height=4, cache=TRUE}
gg <- ggplot(results, aes(x = as.character(scenario_id), y = ale))
gg <- gg + scale_y_continuous(label = dollar_millions)
gg <- gg + stat_boxplot(geom = 'errorbar', width = 0.5)
gg <- gg + geom_boxplot(fill = viridis(1), alpha = 1/3)
gg <- gg + labs(x = "Risk Scenario", y = "Annual Loss", 
                caption = "Source: Evaluator toolkit")
gg <- gg + theme_evaluator()
gg <- gg + theme(panel.grid.major = element_blank())
gg <- gg + theme(panel.grid.minor = element_blank())
gg <- gg + facet_grid(~ domain_id, scales = "free_x", space = "free_x", switch = "x")
gg
```


Row
-----------------------------------------------------------------------

### Control Gaps/Surplus by Domain

```{r control_table}
select(control_weakness, domain, vuln, tc_exceedance, diff_exceedance) %>% 
  rename("Domain" = domain, 
       "Succesful Threat Events" = vuln,
       "Control Gap" = tc_exceedance,
       "Surplus Control Strength" = diff_exceedance) %>% 
  pander(justify = c("left", "right", "right", "right"), 
         split.cells = c(35, rep(10, 3)))
```

### Projects

```{r}
data(iris)
pander(iris)
```
