---
title: "Risk Dashboard"
author: "Evaluator toolkit"
output:
  flexdashboard::flex_dashboard:
    css: styles/html-styles.css
    favicon: ./img/evaluator_logo_48px.png
    logo: ./img/evaluator_logo_48px.png
    navbar:
    - align: right
      href: https://github.com/davidski/evaluator
      title: About
    orientation: row
    source_code: embed
    vertical_layout: fill
---

Sample narrative section.

```{r setup, include=FALSE}
library(flexdashboard)
if ("pacman" %in% installed.packages()) {
  pacman::p_load(ggplot2, scales, extrafont, viridis, dplyr, purrr)
  pacman::p_load(readr, pander)
} else  {
  library(ggplot2)
  library(scales)
  library(extrafont)
  library(viridis)
  library(dplyr)
  library(purrr)
  library(readr)
  library(pander)
}
knitr::read_chunk("./bin/load_data.R")
knitr::read_chunk("./bin/common_graphs.R")
knitr::read_chunk("./bin/utils.R")
```

```{r load_data, echo = FALSE, message = FALSE}
```

```{r calculate_domain_impact}
```

```{r calculate_weak_domains}
```

```{r common_functions}
```

```{r calculate_max_losses}
```

Executive Summary
=======================================================================

Row
-----------------------------------------------------------------------

### Aggregate 95% Value at Risk

````{r}
overall <- results %>% group_by(simulation) %>% 
                     summarize(ale = sum(ale)) %>% select(ale) %>%
                     ungroup
agg_risk <- quantile(overall$ale, 0.95)
valueBox(dollar_millions(agg_risk), icon = "glyphicon-eye-open",
         color = ifelse(agg_risk > risk_tolerance["high"], "danger", ifelse(
           agg_risk > risk_tolerance["medium"], "warning", "success")))
```

### Minimum Annual Loss (80% Likelihood)

```{r}
loss_exceedance <- quantile(filter(max_loss, outliers==FALSE)$max_loss, .2)
valueBox(dollar_millions(loss_exceedance), icon = "glyphicon-warning-sign",
         color = ifelse(loss_exceedance > risk_tolerance["high"], "danger", ifelse(
           loss_exceedance > risk_tolerance["medium"], "warning", "success")))
```

### Median Loss Events Per Year

```{r median_aggregate_loss_events}
loss_events <- group_by(results, simulation) %>% 
  summarise(n = sum(loss_events)) %>% summarize(loss = median(n)) %>% 
  unlist %>% unname
valueBox(comma(loss_events), icon = "glyphicon-flag",
         color = "info")

```

Row {data-height=150}
-----------------------------------------------------------------------

### Domain Heatmap {.no-padding}

```{r domain_heatmap, fig.width=12, fig.height=2}
```

Row
-----------------------------------------------------------------------

### Scenarios with Simulated Losses {.no-padding}

```{r loss_across_domains, fig.width=15, fig.height=4, cache=TRUE}
results %>% mutate(full_label = paste0(domain_id, " - ", scenario_id)) %>% 
  arrange(domain_id, scenario_id) -> dat 
dat <- group_by(dat, full_label) %>% filter(sum(ale) != 0)
gg <- ggplot(dat, aes(x = full_label, y = ale))
# gg <- gg + geom_rect(aes(ymin=risk_tolerance["medium"], ymax=risk_tolerance["high"], 
#                          xmin=as.character(min(scenario_id)), xmax=as.character(max(scenario_id))), 
#                      fill="#c227b9", alpha = 1/10)
# gg <- gg + geom_rect(aes(ymin=risk_tolerance["high"], ymax = Inf, 
#                          xmin=as.character(min(scenario_id)), xmax=as.character(max(scenario_id))), 
#                      fill="#d60057", alpha = 1/10)
gg <- gg + stat_boxplot(geom = 'errorbar', width = 0.5)
gg <- gg + geom_boxplot(fill = viridis(1), alpha = 1/3)
gg <- gg + facet_wrap(~ full_label, nrow=2, scales = "free_x")
#gg <- gg + facet_grid(~ domain_id, scales = "free", space = "free")
gg <- gg + scale_y_continuous(label = dollar_millions)
gg <- gg + labs(x = "Risk Scenario", y = "Annual\nLoss", 
                caption = "Source: Evaluator toolkit")
gg <- gg + theme_evaluator()
gg <- gg + theme(panel.grid.major = element_blank())
gg <- gg + theme(panel.grid.minor = element_blank())
gg <- gg + theme(axis.title.y = element_text(angle = 0, vjust = 0.5, hjust = 0))
gg <- gg + theme(strip.text.x = element_blank())
gg
```


Row
-----------------------------------------------------------------------

### Control Gaps/Surplus by Domain

```{r control_table}
select(control_weakness, domain, vuln, tc_exceedance, diff_exceedance) %>% 
  rename("Domain" = domain, 
       "Succesful Threat Events" = vuln,
       "Control Gap" = tc_exceedance,
       "Surplus Control Strength" = diff_exceedance) %>% 
  pander(justify = c("left", "right", "right", "right"), 
         split.cells = c(35, rep(10, 3)))
```

### Projects

```{r}
data(iris)
pander(iris)
```
