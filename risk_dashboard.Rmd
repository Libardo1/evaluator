---
title: "Risk Dashboard"
author: "Evaluator toolkit"
output:
  flexdashboard::flex_dashboard:
    css: styles/html-styles.css
    favicon: ./img/evaluator_logo_48px.png
    logo: ./img/evaluator_logo_48px.png
    navbar:
    - align: right
      href: https://github.com/davidski/evaluator
      title: About
    orientation: row
    source_code: embed
    vertical_layout: fill
  pdf_document: default
---

Sample narrative section.

```{r setup, include=FALSE}
if ("pacman" %in% installed.packages()) {
  pacman::p_load(flexdashboard)
  pacman::p_load(ggplot2, scales, extrafont, viridis, dplyr, purrr)
  pacman::p_load(readr, pander)
} else  {
  library(flexdashboard)
  library(ggplot2)
  library(scales)
  library(extrafont)
  library(viridis)
  library(dplyr)
  library(purrr)
  library(readr)
  library(pander)
}
knitr::opts_chunk$set(echo = FALSE) 

knitr::read_chunk("./bin/load_data.R")
knitr::read_chunk("./bin/common_graphs.R")
knitr::read_chunk("./bin/utils.R")
```

```{r load_data, echo = FALSE, message = FALSE}
```

```{r calculate_domain_impact}
```

```{r calculate_weak_domains}
```

```{r common_functions}
```

```{r calculate_max_losses}
```

risk dashboard
=======================================================================

value boxes
-----------------------------------------------------------------------

### aggregate 95% value at risk

````{r var_valuebox}
overall <- results %>% group_by(simulation) %>% 
                     summarize(ale = sum(ale)) %>% select(ale) %>%
                     ungroup
agg_risk <- quantile(overall$ale, 0.95)
valuebox(dollar_millions(agg_risk), icon = "glyphicon-eye-open",
         color = ifelse(agg_risk > risk_tolerance["high"], "danger", ifelse(
           agg_risk > risk_tolerance["medium"], "warning", "success")))
```

### minimum annual loss (80% likelihood)

```{r ale_exceedance_valuebox}
loss_exceedance <- quantile(filter(max_loss, outliers==false)$max_loss, .2)
valuebox(dollar_millions(loss_exceedance), icon = "glyphicon-warning-sign",
         color = ifelse(loss_exceedance > risk_tolerance["high"], "danger", ifelse(
           loss_exceedance > risk_tolerance["medium"], "warning", "success")))
```

### median loss events per year

```{r median_aggregate_loss_events}
loss_events <- group_by(results, simulation) %>% 
  summarise(n = sum(loss_events)) %>% summarize(loss = median(n)) %>% 
  unlist %>% unname
valuebox(comma(loss_events), icon = "glyphicon-flag",
         color = "info")

```

domain summary {data-height=150}
-----------------------------------------------------------------------

### domain heatmap {.no-padding}

```{r domain_heatmap, include = false}
```

```{r display, fig.width=15, fig.height=1}
# modify the base plot for displaying on the dashboard
gg <- gg + labs(title=null, caption = null)
gg <- gg + theme(legend.position = "right")
gg <- gg + guides(fill = false)
gg
```

scenario results
-----------------------------------------------------------------------

### top 10 scenarios with simulated losses {.no-padding}

```{r loss_across_domains, fig.width=10, fig.height=3, cache=true}
sum_bottom_n <- function(dat, top_n=10, sortby="max_ale") {
  cluster_hack <- max(dat$cluster_id)
  full_label <- "full_label"
  
  # assign a flag on outliers
  keep_nokeep <- dat %>% group_by_(full_label) %>% 
    summarise_(foo= ~max(sortby)) %>% 
    mutate(keep = ifelse(row_number() <= top_n, true, false)) %>% 
    select(-foo)
  
  # sum up the outliers
  others <- filter(keep_nokeep, keep==false) %>% 
    left_join(dat, by="full_label") %>% 
    group_by(simulation) %>% summarize(ale = max(ale), scenario_count = n()) %>% 
    mutate(full_label = paste0("others (", scenario_count, ")")) %>% 
    mutate(cluster_id = cluster_hack)
  
  # combine the outliers with the top_n items
  union_all(filter(keep_nokeep, keep==TRUE) %>% 
              left_join(dat, by="full_label"), others)
}


# assign the text label to scenarios and order
results %>% mutate(full_label = paste0(domain_id, " - ", scenario_id)) %>% 
  arrange(domain_id, scenario_id) -> dat 

# remove no loss scenarios, enhance, and cluster
dat <- group_by(dat, full_label) %>% filter(sum(ale) != 0) %>% 
  mutate(var = quantile(ale, 0.95), max_ale = max(ale), ale_median = median(ale)) %>% 
  ungroup %>% 
  mutate(cluster_id = kmeans(max_ale, 3)$cluster)

# assign labels to the clusters
text_labels <- c("high", "medium", "low")
cluster_descriptions <- group_by(dat, cluster_id, full_label) %>% 
  summarize(ale = max(max_ale)) %>% 
  summarise(highest_ale = max(ale), n=n()) %>% 
  arrange(desc(highest_ale)) %>% 
  mutate(cluster_labels=factor(text_labels, levels = text_labels),
         top_n = min(last(n), n))

summed_dat <- group_by(dat, cluster_id) %>% 
  left_join(cluster_descriptions, by="cluster_id") %>% do(sum_bottom_n(., top_n=max(.$top_n))) %>% 
  select(-c(cluster_labels, n, top_n, highest_ale)) %>% 
  left_join(cluster_descriptions, by="cluster_id") %>% ungroup

summed_dat <- group_by(summed_dat, full_label) %>% mutate(ale_median = median(ale))
  
filter(dat, ale!=0) %>% group_by(full_label) %>% 
  mutate(ale_median = median(ale)) %>% ungroup %>%  
         mutate(full_label = fct_reorder(full_label, ale_median)) -> minimal_dat

ggplot(minimal_dat, aes(x = full_label, y = ale + 1)) -> gg
#gg <- ggplot(summed_dat, aes(x = fct_reorder(full_label, ale_median), y = ale))

gg <- gg + stat_boxplot(geom = 'errorbar', width = 0.4)
#gg <- gg + geom_boxplot(aes(fill = keep), alpha = 1/3)
gg <- gg + geom_boxplot(fill = viridis(1), coef = 0, alpha = 1/3)
gg <- gg + scale_fill_viridis(discrete = TRUE)
#gg <- gg + facet_wrap(~ cluster_labels, nrow=1, scales = "free")
gg <- gg + scale_y_log10(label = dollar, minor_breaks = seq(1, max(gg$data$ale), 100000))
gg <- gg + guides(fill = FALSE)
gg <- gg + coord_flip()
gg <- gg + labs(x = NULL, y = "Annual\nLoss") 
gg <- gg + theme_evaluator()
gg <- gg + theme(panel.grid.major.x = element_line())
gg <- gg + theme(panel.grid.minor.x = element_line(color="grey92"))
#gg <- gg + theme(panel.grid.major = element_blank())
#gg <- gg + theme(panel.grid.minor = element_blank())
gg <- gg + theme(axis.title.y = element_text(angle = 0, vjust = 0.5, hjust = 0))
gg
```


Details
-----------------------------------------------------------------------

### Control Gaps/Surplus by Domain

```{r control_table}
select(control_weakness, domain, vuln, tc_exceedance, diff_exceedance) %>% 
  rename("Domain" = domain, 
       "Succesful Threat Events" = vuln,
       "Control Gap" = tc_exceedance,
       "Surplus Control Strength" = diff_exceedance) %>% 
  pander(justify = c("left", "right", "right", "right"), 
         split.cells = c(35, rep(10, 3)))
```

### Top Risk Scenarios

```{r top_risk_scenarios}
top_n(scenario_summary, 5, ale_var) %>% 
  arrange(desc(ale_var)) %>% 
  left_join(scenarios, by = c("scenario_id" = "scenario_id", 
                              "domain_id" = "domain_id")) %>%
  mutate(ale_var = dollar(ale_var), ale_median = dollar(ale_median)) %>% 
  select("Domain ID" = domain_id, Scenario = scenario, 
         "Median Annual Loss" = ale_median, "Value at Risk" = ale_var) %>% 
  pander(justify = c(rep("left", 2), rep("right", 2)))
```
